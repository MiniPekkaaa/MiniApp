<!DOCTYPE html>
<html>
<head>
    <title>–ö–æ—Ä–∑–∏–Ω–∞</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #5288c1;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }

        .notification {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 2000;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateY(0);
        }

        .notification .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0 10px;
        }

        .cart-container {
            padding-top: 0;
            transition: padding-top 0.3s ease;
        }

        .cart-container.with-notification {
            padding-top: 50px;
        }

        .cart-item {
            background-color: var(--tg-theme-secondary-bg-color);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 12px;
            position: relative;
        }

        .cart-item-info {
            margin-bottom: 12px;
        }

        .cart-item-name {
            font-size: 16px;
            margin: 0 0 8px 0;
            color: var(--tg-theme-text-color);
        }

        .cart-item-details {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
        }

        .cart-item-details p {
            margin: 4px 0;
        }

        .cart-item-controls {
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }

        .edit-volume-container {
            position: relative;
            flex: 1;
        }

        .quantity-editor {
            display: none;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .quantity-input {
            width: 60px;
            text-align: center;
            padding: 4px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
        }

        .quantity-editor .button {
            padding: 4px 8px;
        }

        .button-delete {
            background-color: #ff4444;
            color: white;
        }

        .button-order {
            background-color: #4CAF50;
            color: white;
        }

        .button-add-more {
            background-color: #5288c1;
            color: white;
            margin-bottom: 10px;
        }

        .quantity-line {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .button-confirm {
            background-color: #4CAF50;
            color: white;
        }

        .button-cancel {
            background-color: #ff4444;
            color: white;
        }

        /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª—å –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ —Å TARA=true */
        .cart-item.tara-item {
            background-color: rgba(255, 193, 7, 0.2); /* –ó–æ–ª–æ—Ç–∏—Å—Ç—ã–π –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω */
            border-left: 4px solid #ffc107; /* –ó–æ–ª–æ—Ç–∏—Å—Ç–∞—è –±–æ–∫–æ–≤–∞—è –ø–æ–ª–æ—Å–∞ */
        }

        .tara-badge {
            display: inline-block;
            background-color: #ffc107;
            color: #333;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            vertical-align: middle;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- –î–æ–±–∞–≤–ª—è–µ–º div –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="notification" class="notification">
        <span id="notification-text"></span>
        <button class="close-btn" onclick="hideNotification()">&times;</button>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loading" class="container" style="text-align: center; padding: 20px;">
        <div class="loader"></div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div id="content" class="hidden">
        <div class="container cart-container" id="cartContainer">
            <h2 style="margin: 0 0 15px 0; text-align: center;">–ö–æ—Ä–∑–∏–Ω–∞</h2>
            <div id="cart_items">
                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ç–æ–≤–∞—Ä—ã -->
            </div>
            <div id="show_more_container" style="display: none;">
                <button onclick="toggleShowAll()" class="button" id="show_more_button">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
            </div>
            <div id="cart_total" style="margin: 15px 0; padding: 15px; background-color: var(--tg-theme-secondary-bg-color); border-radius: 12px; text-align: center;">
                <h3>–ò—Ç–æ–≥–æ: <span id="total_amount">0</span>‚ÇΩ</h3>
            </div>
            <button onclick="addMore()" class="button button-add-more">–î–æ–±–∞–≤–∏—Ç—å –µ—â—ë</button>
            <button onclick="placeOrder()" class="button button-order">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
            <button onclick="goBack()" class="button">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        
        // –ü–æ–ª—É—á–∞–µ–º user_id –∏–∑ Telegram WebApp
        const userId = tg.initDataUnsafe?.user?.id;
        
        function showNotification(message, duration = 20000) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            const cartContainer = document.getElementById('cartContainer');
            
            notificationText.textContent = message;
            notification.classList.add('show');
            if (cartContainer) {
                cartContainer.classList.add('with-notification');
            }

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
            setTimeout(() => {
                hideNotification();
            }, duration);
        }

        function hideNotification() {
            const notification = document.getElementById('notification');
            const cartContainer = document.getElementById('cartContainer');
            
            notification.classList.remove('show');
            if (cartContainer) {
                cartContainer.classList.remove('with-notification');
            }
        }

        function showContent() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').classList.remove('hidden');
        }

        function checkAuthAndRedirect() {
            if (!window.location.search.includes('user_id') && userId) {
                window.location.href = `${window.location.pathname}?user_id=${userId}`;
            } else {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é
                const recommendation = sessionStorage.getItem('recommendation');
                if (recommendation) {
                    showNotification(recommendation);
                    // –£–¥–∞–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –∏–∑ sessionStorage –ø–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞
                    sessionStorage.removeItem('recommendation');
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ TARA
                loadInitialProducts();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                setTimeout(showContent, 300);
            }
        }
        
        let cart = [];
        let initialProducts = null;
        try {
            const savedCart = sessionStorage.getItem('cart');
            if (savedCart) {
                cart = JSON.parse(savedCart);
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
                cart = cart.map(item => ({
                    ...item,
                    quantity: parseInt(item.quantity) || 0
                }));
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ—Ä–∑–∏–Ω—ã:', error);
            cart = [];
        }
        
        let showAll = false;
        
        function displayCart() {
            const cartItems = document.getElementById('cart_items');
            const showMoreContainer = document.getElementById('show_more_container');
            const showMoreButton = document.getElementById('show_more_button');
            const cartTotal = document.getElementById('cart_total');
            
            cartItems.innerHTML = '';
            
            if (!Array.isArray(cart) || cart.length === 0) {
                cartItems.innerHTML = '<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
                showMoreContainer.style.display = 'none';
                cartTotal.style.display = 'none';
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –æ–±—â–µ–π —Å—É–º–º–æ–π
            cartTotal.style.display = 'block';
            
            // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã —Å —Ü–µ–Ω–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0
            renderCartItems();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å "–º–∏–≥–∞–Ω–∏–µ" —Ü–µ–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            setTimeout(() => {
                // –ü–æ–ª—É—á–∞–µ–º ID –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
                getUserOrgData()
                    .then(userData => {
                        console.log('–î–∞–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ:', userData);
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞—Ä—Ç—É UID –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                        window.uidMap = userData.uid_map || {};
                        console.log('–ö–∞—Ä—Ç–∞ UID —Ç–æ–≤–∞—Ä–æ–≤:', window.uidMap);
                        
                        // –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞—Ç–Ω—É—é –∫–∞—Ä—Ç—É: UID -> –∏–Ω–¥–µ–∫—Å —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
                        window.uidToCartItemMap = {};
                        
                        // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Ü–µ–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º UID
                        const positions = cart.map((item, index) => {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ UID –≤ –∫–∞—Ä—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
                            const uid = userData.uid_map && userData.uid_map[item.id] ? 
                                      userData.uid_map[item.id] : item.id;
                            
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ UID -> –∏–Ω–¥–µ–∫—Å —Ç–æ–≤–∞—Ä–∞
                            window.uidToCartItemMap[uid] = index;
                            console.log(`–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ UID ${uid} -> —Ç–æ–≤–∞—Ä ${item.name} (–∏–Ω–¥–µ–∫—Å ${index})`);
                            
                            return {
                                ID_product: uid,
                                Amount: item.quantity
                            };
                        });
                        
                        console.log('–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Å UID:', positions);
                        console.log('–ö–∞—Ä—Ç–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è UID -> –∏–Ω–¥–µ–∫—Å —Ç–æ–≤–∞—Ä–∞:', window.uidToCartItemMap);
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
                        return calculatePrices({
                            ID_customer: String(userData.organization_id || userData.customer_id || ''),
                            INN_legal_entity: String(userData.legal_entity || '2724132975'),
                            positions: positions
                        });
                    })
                    .then(priceData => {
                        console.log('–î–∞–Ω–Ω—ã–µ –æ —Ü–µ–Ω–∞—Ö –ø–æ–ª—É—á–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ:', priceData);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–∫–∏ –≤ –æ—Ç–≤–µ—Ç–µ
                        if (typeof priceData === 'string' && priceData.includes('–ù–µ –Ω–∞—à–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é')) {
                            console.error('–û—à–∏–±–∫–∞ API:', priceData);
                            showNotification('–û—à–∏–±–∫–∞ API: ' + priceData);
                            
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                            const testData = getTestPriceData();
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ü–µ–Ω–∞—Ö –≤ –æ–±—ä–µ–∫—Ç—ã –∫–æ—Ä–∑–∏–Ω—ã
                            testData.Korzina.forEach(priceItem => {
                                const cartItem = cart.find(item => item.id === priceItem.ID_product);
                                if (cartItem) {
                                    cartItem.price = priceItem.Price;
                                    console.log(`–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è —Ü–µ–Ω–∞ ${priceItem.Price} –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${cartItem.name}`);
                                }
                            });
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ —Ü–µ–Ω–∞–º–∏
                            renderCartItems();
                            
                            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—â—É—é —Å—É–º–º—É
                            document.getElementById('total_amount').textContent = testData.Summa.toFixed(2);
                            return;
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ü–µ–Ω–∞—Ö –≤ –æ–±—ä–µ–∫—Ç—ã –∫–æ—Ä–∑–∏–Ω—ã
                        if (priceData && priceData.Korzina) {
                            console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ —Ü–µ–Ω–∞—Ö:', priceData);
                            
                            // –í—ã–≤–æ–¥–∏–º –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–∞—Ö –≤ –∫–æ—Ä–∑–∏–Ω–µ –∏ –∏—Ö ID
                            console.log('–¢–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ:');
                            cart.forEach((item, index) => {
                                console.log(`[${index}] –¢–æ–≤–∞—Ä: ${item.name}, ID: ${item.id}, UID –∏–∑ –∫–∞—Ä—Ç—ã: ${window.uidMap && window.uidMap[item.id] || '–Ω–µ—Ç'}, TARA: ${item.TARA ? '–¥–∞' : '–Ω–µ—Ç'}`);
                            });
                            
                            // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ –æ —Å–≤–æ–π—Å—Ç–≤–µ TARA
                            const taraCatalogItems = initialProducts ? initialProducts.filter(p => p.TARA).map(p => p.id) : [];
                            console.log('–¢–æ–≤–∞—Ä—ã —Å TARA=true –≤ –∫–∞—Ç–∞–ª–æ–≥–µ (ID):', taraCatalogItems);
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É TARA –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
                            cart.forEach(item => {
                                // –ï—Å–ª–∏ —É —Ç–æ–≤–∞—Ä–∞ –Ω–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞ TARA, –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ–≥–æ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
                                if (item.TARA === undefined && window.initialProducts) {
                                    const catalogItem = window.initialProducts.find(p => p.id === item.id);
                                    if (catalogItem && catalogItem.TARA) {
                                        console.log(`–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º TARA=true –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${item.name} –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–∞—Ç–∞–ª–æ–≥–∞`);
                                        item.TARA = true;
                                    }
                                }
                            });
                            
                            // –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–∞—Ö –≤ –æ—Ç–≤–µ—Ç–µ API
                            console.log('–¢–æ–≤–∞—Ä—ã –≤ –æ—Ç–≤–µ—Ç–µ API:');
                            priceData.Korzina.forEach((priceItem, index) => {
                                console.log(`[${index}] ID_product: ${priceItem.ID_product}, Price: ${priceItem.Price}`);
                            });
                            
                            // –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Ü–µ–Ω –ø–æ UID
                            const priceMap = {};
                            priceData.Korzina.forEach(priceItem => {
                                priceMap[priceItem.ID_product] = priceItem.Price;
                            });
                            
                            // –û—Ç–¥–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Ü–µ–Ω—ã –ø–æ –∏–Ω–¥–µ–∫—Å—É
                            const priceByIndex = priceData.Korzina.map(item => item.Price);
                            
                            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–µ–Ω—ã –∫ —Ç–æ–≤–∞—Ä–∞–º –≤ –∫–æ—Ä–∑–∏–Ω–µ
                            let appliedCount = 0;
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–∞—Ä—Ç–∞ UID
                            if (window.uidMap) {
                                console.log('–ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–µ–Ω—ã –ø–æ –∫–∞—Ä—Ç–µ UID');
                                cart.forEach((item, index) => {
                                    const itemUid = window.uidMap[item.id];
                                    if (itemUid && priceMap[itemUid]) {
                                        const price = priceMap[itemUid];
                                        console.log(`‚úÖ –ü–æ UID: –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ü–µ–Ω–∞ ${price} –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${item.name} (ID: ${item.id}, UID: ${itemUid})`);
                                        item.price = price;
                                        appliedCount++;
                                    } else {
                                        console.log(`‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Ü–µ–Ω–∞ –ø–æ UID –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${item.name} (ID: ${item.id})`);
                                    }
                                });
                            }
                            
                            // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å —Ç–æ–≤–∞—Ä—ã –±–µ–∑ —Ü–µ–Ω, –ø—Ä–æ–±—É–µ–º –ø—Ä—è–º–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ ID
                            cart.forEach((item, index) => {
                                if (!item.price && priceMap[item.id]) {
                                    const price = priceMap[item.id];
                                    console.log(`‚úÖ –ü–æ ID: –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ü–µ–Ω–∞ ${price} –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${item.name} (ID: ${item.id})`);
                                    item.price = price;
                                    appliedCount++;
                                }
                            });
                            
                            // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã –±–µ–∑ —Ü–µ–Ω, –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ–≤–ø–∞–¥–∞–µ—Ç - –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –ø–æ –∏–Ω–¥–µ–∫—Å—É
                            if (appliedCount < cart.length && cart.length === priceData.Korzina.length) {
                                console.log('–ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–µ–Ω—ã –ø–æ –∏–Ω–¥–µ–∫—Å—É (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ–≤–ø–∞–¥–∞–µ—Ç)');
                                cart.forEach((item, index) => {
                                    if (!item.price && priceByIndex[index]) {
                                        const price = priceByIndex[index];
                                        console.log(`‚úÖ –ü–æ –∏–Ω–¥–µ–∫—Å—É: –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ü–µ–Ω–∞ ${price} –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${item.name} (–∏–Ω–¥–µ–∫—Å: ${index})`);
                                        item.price = price;
                                        appliedCount++;
                                    }
                                });
                            }
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ —Ç–æ–≤–∞—Ä—ã –ø–æ–ª—É—á–∏–ª–∏ —Ü–µ–Ω—ã
                            const itemsWithoutPrice = cart.filter(item => !item.price).length;
                            if (itemsWithoutPrice > 0) {
                                console.warn(`‚ö†Ô∏è ${itemsWithoutPrice} —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ —Ü–µ–Ω—ã`);
                            }
                            
                            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—â—É—é —Å—É–º–º—É –∏–∑ –æ—Ç–≤–µ—Ç–∞ API
                            if (priceData.Summa !== undefined) {
                                document.getElementById('total_amount').textContent = parseFloat(priceData.Summa).toFixed(2);
                                console.log(`–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –æ–±—â–∞—è —Å—É–º–º–∞ –∏–∑ API: ${priceData.Summa}`);
                            }
                            
                            console.log(`–ò—Ç–æ–≥: –£—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ ${appliedCount} —Ü–µ–Ω –∏–∑ ${priceData.Korzina.length} –≤–æ–∑–º–æ–∂–Ω—ã—Ö –¥–ª—è ${cart.length} —Ç–æ–≤–∞—Ä–æ–≤`);
                        } else {
                            console.warn('–í –æ—Ç–≤–µ—Ç–µ API –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –æ —Ü–µ–Ω–∞—Ö');
                        }
                        
                        // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–∞—Ö –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ü–µ–Ω
                        console.log('–¢–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ü–µ–Ω:', JSON.stringify(cart, null, 2));
                        updateProcessIndicator('–≠—Ç–∞–ø: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã');
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã —Å —Ü–µ–Ω–∞–º–∏
                        renderCartItems();
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ü–µ–Ω:', error);
                        
                        // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                        console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ü–µ–Ω');
                        const testData = getTestPriceData();
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ü–µ–Ω–∞—Ö –≤ –æ–±—ä–µ–∫—Ç—ã –∫–æ—Ä–∑–∏–Ω—ã
                        testData.Korzina.forEach(priceItem => {
                            const cartItem = cart.find(item => item.id === priceItem.ID_product);
                            if (cartItem) {
                                cartItem.price = priceItem.Price;
                                console.log(`–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è —Ü–µ–Ω–∞ ${priceItem.Price} –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${cartItem.name}`);
                            }
                        });
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ —Ü–µ–Ω–∞–º–∏
                        renderCartItems();
                        
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—â—É—é —Å—É–º–º—É
                        document.getElementById('total_amount').textContent = testData.Summa.toFixed(2);
                    });
            }, 300);
            
            function renderCartItems() {
                const itemsToShow = showAll ? cart.length : Math.min(5, cart.length);
                
                if (cart.length > 5) {
                    showMoreContainer.style.display = 'block';
                    showMoreButton.textContent = showAll ? '–°–≤–µ—Ä–Ω—É—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ';
                } else {
                    showMoreContainer.style.display = 'none';
                }
                
                cartItems.innerHTML = '';
                let totalSum = 0;
                
                console.log('–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ:', cart);
                console.log('UID –∫–∞—Ä—Ç–∞:', window.uidMap);
                
                // –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥–∏ TARA –¥–ª—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
                cart.forEach(item => {
                    item.TARA = false;
                });
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º TARA
                if (window.initialProducts && window.initialProducts.length > 0) {
                    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É UID -> { TARA, name } –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
                    const uidTaraMap = {};
                    window.initialProducts.forEach(item => {
                        if (item.UID) {
                            uidTaraMap[item.UID] = {
                                TARA: item.TARA === true,
                                name: item.name
                            };
                        }
                    });
                    
                    console.log('–°–æ–∑–¥–∞–Ω–∞ –∫–∞—Ä—Ç–∞ UID -> TARA:', uidTaraMap);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –≤ –∫–æ—Ä–∑–∏–Ω–µ "–ë–∞–ª–ª–æ–Ω (v-)"
                    const balloonInCart = cart.find(item => item.name === "–ë–∞–ª–ª–æ–Ω (v-)");
                    if (balloonInCart) {
                        console.log('"–ë–∞–ª–ª–æ–Ω (v-)" –Ω–∞–π–¥–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω–µ:', balloonInCart);
                        console.log('ID –≤ –∫–æ—Ä–∑–∏–Ω–µ:', balloonInCart.id);
                        console.log('UID –≤ –∫–æ—Ä–∑–∏–Ω–µ:', balloonInCart.uid);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–æ–π UID –≤ –∫–∞—Ä—Ç–µ uidTaraMap
                        if (balloonInCart.uid && uidTaraMap[balloonInCart.uid]) {
                            console.log('–ù–∞–π–¥–µ–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ UID –≤ –∫–∞—Ä—Ç–µ:', uidTaraMap[balloonInCart.uid]);
                        } else {
                            console.log('–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ UID –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ ID —Ç–æ–≤–∞—Ä–∞ –≤ –∫–∞—Ä—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è uidMap
                        if (window.uidMap && window.uidMap[balloonInCart.id]) {
                            const mappedUid = window.uidMap[balloonInCart.id];
                            console.log('–ù–∞–π–¥–µ–Ω UID –≤ –∫–∞—Ä—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:', mappedUid);
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —ç—Ç–æ—Ç UID –≤ –∫–∞—Ä—Ç–µ TARA
                            if (uidTaraMap[mappedUid]) {
                                console.log('–ù–∞–π–¥–µ–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ –º–∞–ø–ø–∏–Ω–≥—É –≤ –∫–∞—Ä—Ç–µ:', uidTaraMap[mappedUid]);
                            } else {
                                console.log('–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ –º–∞–ø–ø–∏–Ω–≥—É –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                            }
                        } else {
                            console.log('ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–∞—Ä—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è uidMap');
                        }
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω–µ
                    cart.forEach(item => {
                        console.log(`üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ TARA –¥–ª—è —Ç–æ–≤–∞—Ä–∞: ${item.name} (ID: ${item.id})`);
                        
                        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ UID –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã, –µ—Å–ª–∏ –µ—Å—Ç—å
                        if (item.uid) {
                            console.log(`–¢–æ–≤–∞—Ä –∏–º–µ–µ—Ç –ø—Ä—è–º–æ–π UID: ${item.uid}`);
                            if (uidTaraMap[item.uid] && uidTaraMap[item.uid].TARA) {
                                item.TARA = true;
                                console.log(`‚úÖ –ù–ê–ô–î–ï–ù–û! –¢–æ–≤–∞—Ä ${item.name} –∏–º–µ–µ—Ç TARA=true –ø–æ –ø—Ä—è–º–æ–º—É UID: ${item.uid}`);
                            } else {
                                console.log(`‚ùå TARA –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ –ø—Ä—è–º–æ–º—É UID: ${item.uid}`);
                            }
                        } else {
                            console.log(`‚ùå –¢–æ–≤–∞—Ä ${item.name} –Ω–µ –∏–º–µ–µ—Ç –ø—Ä—è–º–æ–≥–æ UID`);
                        }
                        
                        // 2. –ï—Å–ª–∏ UID –Ω–µ—Ç –≤ –∫–æ—Ä–∑–∏–Ω–µ, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∫–∞—Ä—Ç—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
                        if (!item.TARA && window.uidMap && window.uidMap[item.id]) {
                            const mappedUid = window.uidMap[item.id];
                            console.log(`–ù–∞–π–¥–µ–Ω UID –≤ –∫–∞—Ä—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è: ${mappedUid} –¥–ª—è ID: ${item.id}`);
                            
                            if (uidTaraMap[mappedUid] && uidTaraMap[mappedUid].TARA) {
                                item.TARA = true;
                                console.log(`‚úÖ –ù–ê–ô–î–ï–ù–û! –¢–æ–≤–∞—Ä ${item.name} –∏–º–µ–µ—Ç TARA=true –ø–æ UID –∏–∑ –∫–∞—Ä—Ç—ã: ${mappedUid}`);
                            } else {
                                console.log(`‚ùå TARA –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ UID –∏–∑ –∫–∞—Ä—Ç—ã: ${mappedUid}`);
                            }
                        } else if (!item.TARA) {
                            console.log(`‚ùå ID —Ç–æ–≤–∞—Ä–∞ ${item.id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–∞—Ä—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è UID`);
                        }
                        
                        // 3. –ö–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç, –∏—â–µ–º –ø–æ ID –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
                        if (!item.TARA) {
                            const catalogItem = window.initialProducts.find(p => 
                                p.id && p.id.toString() === item.id.toString()
                            );
                            
                            if (catalogItem) {
                                console.log(`–ù–∞–π–¥–µ–Ω —Ç–æ–≤–∞—Ä –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –ø–æ ID ${item.id}:`, catalogItem);
                                if (catalogItem.TARA === true) {
                                    item.TARA = true;
                                    console.log(`‚úÖ –ù–ê–ô–î–ï–ù–û! –¢–æ–≤–∞—Ä ${item.name} –∏–º–µ–µ—Ç TARA=true –ø–æ ID: ${item.id}`);
                                } else {
                                    console.log(`‚ùå –¢–æ–≤–∞—Ä –Ω–∞–π–¥–µ–Ω –ø–æ ID, –Ω–æ TARA=${catalogItem.TARA}, —Ç–∏–ø: ${typeof catalogItem.TARA}`);
                                }
                            } else {
                                console.log(`‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –ø–æ ID: ${item.id}`);
                            }
                        }
                        
                        // –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
                        console.log(`–ò—Ç–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ TARA –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${item.name}: ${item.TARA ? 'true' : 'false'}`);
                    });
                } else {
                    console.log('‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ TARA');
                }
                
                cart.forEach((item, index) => {
                    if (index >= itemsToShow) return;
                    
                    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ price —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º
                    const price = parseFloat(item.price) || 0;
                    console.log(`–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–æ–≤–∞—Ä–∞ ${item.name}, —Ü–µ–Ω–∞: ${price}, TARA: ${item.TARA ? 'true' : 'false'}`);
                    
                    const itemTotal = price * (parseInt(item.quantity) || 0);
                    totalSum += itemTotal;
                    
                    const itemElement = document.createElement('div');
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–æ–≤–∞—Ä —Ç–∞—Ä–æ–π –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –∫–ª–∞—Å—Å
                    itemElement.className = `cart-item${item.TARA ? ' tara-item' : ''}`;
                    
                    console.log(`–≠–ª–µ–º–µ–Ω—Ç—É –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${item.name} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–ª–∞—Å—Å: ${itemElement.className}`);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É HTML-—ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ –µ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è
                    setTimeout(() => {
                        const renderedItems = document.querySelectorAll('.cart-item');
                        renderedItems.forEach((renderedItem, idx) => {
                            if (idx === index) {
                                console.log(`–ü—Ä–æ–≤–µ—Ä–∫–∞ DOM –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${item.name}:`, {
                                    className: renderedItem.className,
                                    hasTaraClass: renderedItem.classList.contains('tara-item'),
                                    TARA: item.TARA
                                });
                            }
                        });
                    }, 100);
                    
                    // –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∫—É –¢–ê–†–ê, –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä —è–≤–ª—è–µ—Ç—Å—è —Ç–∞—Ä–æ–π
                    const taraLabel = item.TARA ? '<span class="tara-badge">–¢–ê–†–ê</span>' : '';
                    
                    itemElement.innerHTML = `
                        <div class="cart-item-info">
                            <h3 class="cart-item-name">${item.name}${taraLabel}</h3>
                            <div class="cart-item-details">
                                <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${item.quantity}</p>
                                <p>–¶–µ–Ω–∞: ${price.toFixed(2)}‚ÇΩ</p>
                                <p>–°—É–º–º–∞: ${itemTotal.toFixed(2)}‚ÇΩ</p>
                            </div>
                        </div>
                        <div class="cart-item-controls">
                            <button onclick="removeItem(${index})" class="button button-delete">–£–¥–∞–ª–∏—Ç—å</button>
                            <div class="edit-volume-container">
                                <button onclick="toggleQuantityEditor(this, ${index})" class="button">–ò–∑–º–µ–Ω–∏—Ç—å –æ–±—ä–µ–º</button>
                                <div class="quantity-editor">
                                    <div class="quantity-controls">
                                        <button onclick="decrementEditorQuantity(this)" class="button">‚àí</button>
                                        <input type="number" value="${item.quantity}" min="1" class="quantity-input editor-quantity">
                                        <button onclick="incrementEditorQuantity(this)" class="button">+</button>
                                    </div>
                                    <div style="display: flex; justify-content: center; gap: 8px;">
                                        <button onclick="saveQuantity(this, ${index})" class="button button-confirm">‚úì</button>
                                        <button onclick="cancelEditing(this)" class="button button-cancel">‚úï</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    cartItems.appendChild(itemElement);
                });
                
                console.log(`–û–±—â–∞—è —Å—É–º–º–∞ —Ä–∞—Å—á–∏—Ç–∞–Ω–∞: ${totalSum.toFixed(2)}‚ÇΩ`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—É–º–º—É
                if (!document.getElementById('total_amount').textContent || 
                    document.getElementById('total_amount').textContent === '0.00' ||
                    document.getElementById('total_amount').textContent === '0') {
                    document.getElementById('total_amount').textContent = totalSum.toFixed(2);
                }
            }
        }
        
        function toggleShowAll() {
            showAll = !showAll;
            displayCart();
        }
        
        function toggleQuantityEditor(button, index) {
            const editor = button.parentElement.querySelector('.quantity-editor');
            const input = editor.querySelector('.editor-quantity');
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã
            document.querySelectorAll('.quantity-editor').forEach(ed => {
                if (ed !== editor && ed.style.display === 'block') {
                    ed.style.display = 'none';
                }
            });
            
            if (editor.style.display === 'block') {
                editor.style.display = 'none';
            } else {
                editor.style.display = 'block';
                input.value = cart[index].quantity;
            }
        }

        function incrementEditorQuantity(button) {
            const input = button.parentElement.querySelector('.editor-quantity');
            input.value = parseInt(input.value) + 1;
        }

        function decrementEditorQuantity(button) {
            const input = button.parentElement.querySelector('.editor-quantity');
            if (parseInt(input.value) > 1) {
                input.value = parseInt(input.value) - 1;
            }
        }

        function saveQuantity(button, index) {
            const editor = button.closest('.quantity-editor');
            const display = editor.previousElementSibling;
            const newQuantity = parseInt(editor.querySelector('.editor-quantity').value);
            
            if (!isNaN(newQuantity) && newQuantity > 0) {
                cart[index].quantity = newQuantity;
                display.textContent = newQuantity;
                sessionStorage.setItem('cart', JSON.stringify(cart));
                editor.style.display = 'none';
                display.style.display = 'inline';
                displayCart();
            } else {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–±–æ–ª—å—à–µ 0)');
            }
        }

        function cancelEditing(button) {
            const editor = button.closest('.quantity-editor');
            const display = editor.previousElementSibling;
            editor.style.display = 'none';
            display.style.display = 'inline';
        }
        
        function removeItem(index) {
            cart.splice(index, 1);
            sessionStorage.setItem('cart', JSON.stringify(cart));
            displayCart();
        }
        
        function placeOrder() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ
            if (!cart || cart.length === 0) {
                tg.showAlert("–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –ø–µ—Ä–µ–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞.");
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–º–µ—é—Ç —Ü–µ–Ω—ã
            const itemsWithoutPrice = cart.filter(item => !item.price || item.price <= 0);
            if (itemsWithoutPrice.length > 0) {
                tg.showAlert("–ù–µ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–º–µ—é—Ç —Ü–µ–Ω—ã. –î–æ–∂–¥–∏—Ç–µ—Å—å —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification("–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞...", 30000);
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            getUserOrgData()
                .then(userData => {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º userData –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∏–∂–µ
                    window.userData = userData;
                    
                    // –ì–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –≤ 1–°
                    const items = cart.map(item => {
                        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å UID –∏–∑ –∫–∞—Ä—Ç—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
                        let uid = null;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ UID –≤ –∫–∞—Ä—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
                        if (userData.uid_map && userData.uid_map[item.id]) {
                            uid = userData.uid_map[item.id];
                            console.log(`–ù–∞–π–¥–µ–Ω UID –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${item.name} (ID: ${item.id}): ${uid}`);
                        } else {
                            console.warn(`–ù–µ –Ω–∞–π–¥–µ–Ω UID –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${item.name} (ID: ${item.id})`);
                            // –ò—â–µ–º –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –ø–æ –¥—Ä—É–≥–∏–º –ø–æ–ª—è–º, –µ—Å–ª–∏ –µ—Å—Ç—å
                            if (window.initialProducts) {
                                const catalogItem = window.initialProducts.find(p => p.id === item.id);
                                if (catalogItem && catalogItem.UID) {
                                    uid = catalogItem.UID;
                                    console.log(`–ù–∞–π–¥–µ–Ω UID –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${item.name}: ${uid}`);
                                }
                            }
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º UID –≤ –æ–±—ä–µ–∫—Ç —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                        item.uid = uid;
                        
                        // –ï—Å–ª–∏ UID —Ç–∞–∫ –∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –æ—Å–æ–±–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                        if (!uid) {
                            console.warn(`–í–ù–ò–ú–ê–ù–ò–ï: –¢–æ–≤–∞—Ä ${item.name} (ID: ${item.id}) –Ω–µ –∏–º–µ–µ—Ç UID!`);
                        }
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º legalEntity (–æ–±—ã—á–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ —Ç–æ–≤–∞—Ä–µ)
                        const legalEntity = item.legalEntity || "2724132975";
                        
                        // –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞–µ–º name, —Ç–∞–∫ –∫–∞–∫ —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ UID –ø–æ –∏–º–µ–Ω–∏
                        return {
                            id: item.id,
                            uid: uid, // –ü–µ—Ä–µ–¥–∞–µ–º UID —Å—Ç—Ä–æ–∫–æ–π, –¥–∞–∂–µ –µ—Å–ª–∏ null
                            name: item.name || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä", // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ name –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å
                            quantity: parseInt(item.quantity),
                            price: parseFloat(item.price) || 0,
                            legalEntity: legalEntity
                        };
                    });
                    
                    console.log('–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã —Ç–æ–≤–∞—Ä—ã –¥–ª—è –∑–∞–∫–∞–∑–∞:', JSON.stringify(items, null, 2));
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≤ 1–°
                    return fetch('/api/create-1c-order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: userId,
                            items: items
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    });
                })
                .then(ordersData => {
                    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ –≤ 1–°:', ordersData);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–∏–π —É—Å–ø–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–∏
                    if (!ordersData.success) {
                        // –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –∑–∞–∫–∞–∑ –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ
                        let errorMessage = "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑—ã. ";
                        
                        // –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–∞—Ö
                        const errors = ordersData.orders
                            .filter(order => !order.success)
                            .map(order => {
                                const itemNames = order.items.map(item => item.name).join(", ");
                                return `–¢–æ–≤–∞—Ä—ã (${itemNames}): ${order.order.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}`;
                            });
                        
                        if (errors.length > 0) {
                            errorMessage += errors.join("; ");
                        }
                        
                        hideNotification();
                        tg.showAlert(errorMessage);
                        return Promise.reject(new Error(errorMessage));
                    }
                    
                    showNotification("–ó–∞–∫–∞–∑—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...", 10000);
                    
                    // –¢–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–¥–∏–Ω—ã–π –∑–∞–∫–∞–∑ —Å–æ –≤—Å–µ–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏
                    return fetch('/api/save-combined-order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: userId,
                            orders: ordersData.orders,
                            items: cart // –ü–µ—Ä–µ–¥–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
                        })
                    })
                    .then(response => response.json());
                })
                .then(saveResult => {
                    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞:', saveResult);
                    
                    if (!saveResult.success) {
                        throw new Error(saveResult.error || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑");
                    }
                    
                    // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
                    cart = [];
                    sessionStorage.setItem('cart', JSON.stringify(cart));
                    displayCart();
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    hideNotification();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞
                    tg.showAlert("–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!");
                    
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
                    setTimeout(() => {
                        window.location.href = `/main_menu?user_id=${userId}`;
                    }, 1000);
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞:', error);
                    hideNotification();
                    tg.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: ' + error.message);
                });
        }
        
        function addMore() {
            window.location.href = `/products?user_id=${userId}&show_product_selection=true`;
        }
        
        function goBack() {
            window.location.href = `/order_menu?user_id=${userId}`;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function getUserOrgData() {
            console.log('–ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userId);
            
            // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
            const debugMode = false;
            if (debugMode) {
                console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏');
                return Promise.resolve({
                    customer_id: '16d79d5f-a651-11ef-895a-005056c00008',
                    org_ID: '2724132975',
                    organization: '–¢–µ—Å—Ç–æ–≤–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è'
                });
            }
            
            return fetch(`/api/get-user-org-data?user_id=${userId}`)
                .then(response => {
                    console.log('–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, —Å—Ç–∞—Ç—É—Å:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('–î–∞–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω—ã:', data);
                    if (!data.success) {
                        throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏');
                    }
                    return data.data;
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:', error);
                    throw error;
                });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω
        function calculatePrices(requestData) {
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Ä–∞—Å—á–µ—Ç —Ü–µ–Ω:', requestData);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç —Å –ø—Ä–æ–∫—Å–∏-–∑–∞–ø—Ä–æ—Å–æ–º —á–µ—Ä–µ–∑ –Ω–∞—à —Å–µ—Ä–≤–µ—Ä, –µ—Å–ª–∏ –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
            const useProxy = true;
            
            if (useProxy) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –±—ç–∫–µ–Ω–¥ –∫–∞–∫ –ø—Ä–æ–∫—Å–∏
                return fetch('/api/calculate-prices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        DATE: Math.floor(Date.now() / 1000).toString(),
                        ID_customer: requestData.ID_customer || '',
                        INN_legal_entity: requestData.INN_legal_entity || '',
                        positions: requestData.positions || []
                    })
                })
                .then(response => {
                    console.log('–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏, —Å—Ç–∞—Ç—É—Å:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('–î–∞–Ω–Ω—ã–µ –æ —Ü–µ–Ω–∞—Ö –ø–æ–ª—É—á–µ–Ω—ã —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏:', data);
                    return data;
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ü–µ–Ω —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏:', error);
                    throw error;
                });
            } else {
                // –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ –≤–Ω–µ—à–Ω–µ–º—É API
                return fetch('http://87.225.110.142:65531/uttest/hs/int/calculate_checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Basic ' + btoa('int2:pcKnE8GqXn')
                    },
                    body: JSON.stringify({
                        DATE: Math.floor(Date.now() / 1000).toString(),
                        ID_customer: requestData.ID_customer || '',
                        INN_legal_entity: requestData.INN_legal_entity || '',
                        positions: requestData.positions || []
                    })
                })
                .then(response => {
                    console.log('–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, —Å—Ç–∞—Ç—É—Å:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('–î–∞–Ω–Ω—ã–µ –æ —Ü–µ–Ω–∞—Ö –ø–æ–ª—É—á–µ–Ω—ã:', data);
                    return data;
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ü–µ–Ω:', error);
                    throw error;
                });
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ –ø–æ UID
        function findCartItemByUID(uid) {
            console.log(`–ò—â–µ–º —Ç–æ–≤–∞—Ä —Å UID: ${uid}`);
            console.log('–¢–µ–∫—É—â–∏–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ:', cart);
            
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä –Ω–∞–ø—Ä—è–º—É—é –ø–æ id
            let item = cart.find(item => item.id === uid);
            if (item) {
                console.log(`–ù–∞–π–¥–µ–Ω —Ç–æ–≤–∞—Ä –ø–æ id: ${item.name}`);
                return item;
            }
            
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–µ UID, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
            item = cart.find(item => item.UID === uid);
            if (item) {
                console.log(`–ù–∞–π–¥–µ–Ω —Ç–æ–≤–∞—Ä –ø–æ UID: ${item.name}`);
                return item;
            }
            
            // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ uid –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ
            item = cart.find(item => item.uid === uid);
            if (item) {
                console.log(`–ù–∞–π–¥–µ–Ω —Ç–æ–≤–∞—Ä –ø–æ uid (lowercase): ${item.name}`);
                return item;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ UID -> –∏–Ω–¥–µ–∫—Å —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
            if (!window.uidToCartItemMap) {
                window.uidToCartItemMap = {};
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π
            if (window.uidToCartItemMap[uid] !== undefined) {
                const cachedItem = cart[window.uidToCartItemMap[uid]];
                if (cachedItem) {
                    console.log(`–ù–∞–π–¥–µ–Ω —Ç–æ–≤–∞—Ä –∏–∑ –∫–µ—à–∞: ${cachedItem.name}`);
                    return cachedItem;
                }
            }
            
            console.warn(`–¢–æ–≤–∞—Ä —Å UID ${uid} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω–µ`);
            return null;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        function getTestPriceData() {
            const testData = {
                Summa: 0,
                Korzina: []
            };
            
            // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã –ø–æ ID —Ç–æ–≤–∞—Ä–æ–≤
            const fixedPrices = {
                "e2154633-a7ca-11ef-a719-50ebf6b0a0c4": 3860.4, // –†—ã—Ü–∞—Ä—å –ü—Ä–∏–º–æ—Ä—å—è
                "e2154634-a7ca-11ef-a719-50ebf6b0a0c4": 3996.3, // –ë–µ–ª—ã–π –º–µ–¥–≤–µ–¥—å
                "9349": 3860.4, // –ü–æ ID —Ç–æ–≤–∞—Ä–∞
                "9350": 3996.3  // –ü–æ ID —Ç–æ–≤–∞—Ä–∞
            };
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
            cart.forEach((item, index) => {
                // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Ü–µ–Ω—É –ø–æ ID –∏–ª–∏ UID
                let price = fixedPrices[item.id] || 
                           (window.uidMap && fixedPrices[window.uidMap[item.id]]) || 
                           (3800 + (index * 100)); // –†–∞–∑–Ω—ã–µ —Ü–µ–Ω—ã –ø–æ –∏–Ω–¥–µ–∫—Å—É, –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                
                console.log(`–¢–µ—Å—Ç–æ–≤–∞—è —Ü–µ–Ω–∞ –¥–ª—è ${item.name}: ${price}`);
                
                testData.Korzina.push({
                    ID_product: item.id,
                    Price: price
                });
                
                testData.Summa += price * item.quantity;
            });
            
            return testData;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ TARA
        function loadInitialProducts() {
            console.log('[TARA DEBUG] –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ TARA...');
            fetch(`/api/get-products?user_id=${userId}`)
                .then(response => response.json())
                .then(data => {
                    console.log('[TARA DEBUG] –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç API get-products:', data);
                    
                    if (data.success) {
                        window.initialProducts = data.products || [];
                        console.log(`[TARA DEBUG] –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${window.initialProducts.length} —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞`);
                        
                        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã —Å TARA=true –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞
                        const taraProducts = window.initialProducts.filter(p => p.TARA === true);
                        console.log(`[TARA DEBUG] –ù–∞–π–¥–µ–Ω–æ ${taraProducts.length} —Ç–æ–≤–∞—Ä–æ–≤ —Å TARA=true:`, 
                            taraProducts.map(p => ({id: p.id, name: p.name, UID: p.UID, TARA: p.TARA})));
                        
                        // –í—ã–≤–µ–¥–µ–º —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö TARA –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –¥–ª—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤
                        window.initialProducts.forEach((product, index) => {
                            console.log(`[TARA DEBUG] –¢–æ–≤–∞—Ä #${index}: ${product.name}, TARA=${product.TARA}, —Ç–∏–ø=${typeof product.TARA}, ID=${product.id}, UID=${product.UID}`);
                        });
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –±–∞–ª–ª–æ–Ω–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –ø–æ ID –∏ UID
                        const balloonById = window.initialProducts.find(p => p.id === 34 || p.id === "34");
                        if (balloonById) {
                            console.log('[TARA DEBUG] –ë–∞–ª–ª–æ–Ω –Ω–∞–π–¥–µ–Ω –ø–æ ID=34:', balloonById);
                        }
                        
                        const balloonByUID = window.initialProducts.find(p => p.UID === "db8c3457-ce40-11ef-a721-50ebf6b0a0c4");
                        if (balloonByUID) {
                            console.log('[TARA DEBUG] –ë–∞–ª–ª–æ–Ω –Ω–∞–π–¥–µ–Ω –ø–æ UID:', balloonByUID);
                        }
                        
                        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É —Å —É—á–µ—Ç–æ–º –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞
                        renderCartItems();
                    } else {
                        console.error('[TARA DEBUG] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤:', data.error);
                    }
                })
                .catch(error => {
                    console.error('[TARA DEBUG] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤:', error);
                });
        }
        
        function renderCartItems() {
            const itemsToShow = showAll ? cart.length : Math.min(5, cart.length);
            
            if (cart.length > 5) {
                showMoreContainer.style.display = 'block';
                showMoreButton.textContent = showAll ? '–°–≤–µ—Ä–Ω—É—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ';
            } else {
                showMoreContainer.style.display = 'none';
            }
            
            cartItems.innerHTML = '';
            let totalSum = 0;
            
            console.log('[TARA DEBUG] –ù–∞—á–∞–ª–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ:', cart);
            
            // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ TARA
            cart.forEach(item => {
                item.TARA = false;
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ç–∞–ª–æ–≥–∞
            if (!window.initialProducts || window.initialProducts.length === 0) {
                console.error('[TARA DEBUG] –î–∞–Ω–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
            } else {
                // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
                const catalogByUID = {};
                const catalogByID = {};
                
                window.initialProducts.forEach(product => {
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–∞—Ä—Ç—É –ø–æ UID
                    if (product.UID) {
                        catalogByUID[product.UID] = product;
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–∞—Ä—Ç—É –ø–æ ID
                    if (product.id) {
                        catalogByID[product.id] = product;
                    }
                });
                
                console.log('[TARA DEBUG] –°–æ–∑–¥–∞–Ω–∞ –∫–∞—Ä—Ç–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ –ø–æ UID:', catalogByUID);
                console.log('[TARA DEBUG] –°–æ–∑–¥–∞–Ω–∞ –∫–∞—Ä—Ç–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ –ø–æ ID:', catalogByID);
                
                // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤–æ–π—Å—Ç–≤–æ TARA –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞
                cart.forEach(item => {
                    console.log(`[TARA DEBUG] –ü—Ä–æ–≤–µ—Ä–∫–∞ TARA –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${item.name} (ID: ${item.id})`);
                    
                    // –ù–û–í–´–ô –ê–õ–ì–û–†–ò–¢–ú:
                    // 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ UID –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
                    if (item.uid && catalogByUID[item.uid]) {
                        const product = catalogByUID[item.uid];
                        console.log(`[TARA DEBUG] –ù–∞–π–¥–µ–Ω —Ç–æ–≤–∞—Ä –ø–æ UID ${item.uid}:`, product);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤–æ–π—Å—Ç–≤–æ TARA –Ω–∞–ø—Ä—è–º—É—é
                        if (product.TARA === true) {
                            item.TARA = true;
                            console.log(`[TARA DEBUG] ‚úÖ –¢–æ–≤–∞—Ä ${item.name} –∏–º–µ–µ—Ç TARA=true –ø–æ UID ${item.uid}`);
                        } else {
                            console.log(`[TARA DEBUG] ‚ùå –¢–æ–≤–∞—Ä –ø–æ UID ${item.uid} –∏–º–µ–µ—Ç TARA=${product.TARA}`);
                        }
                    }
                    
                    // 2. –ï—Å–ª–∏ TARA –≤—Å–µ –µ—â–µ false –∏ –µ—Å—Ç—å uidMap, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                    if (!item.TARA && window.uidMap && window.uidMap[item.id]) {
                        const mappedUID = window.uidMap[item.id];
                        console.log(`[TARA DEBUG] –ù–∞–π–¥–µ–Ω –º–∞–ø–ø–∏–Ω–≥ ID ${item.id} -> UID ${mappedUID}`);
                        
                        if (catalogByUID[mappedUID]) {
                            const product = catalogByUID[mappedUID];
                            console.log(`[TARA DEBUG] –ù–∞–π–¥–µ–Ω —Ç–æ–≤–∞—Ä –ø–æ –º–∞–ø–ø–∏–Ω–≥—É UID ${mappedUID}:`, product);
                            
                            if (product.TARA === true) {
                                item.TARA = true;
                                console.log(`[TARA DEBUG] ‚úÖ –¢–æ–≤–∞—Ä ${item.name} –∏–º–µ–µ—Ç TARA=true –ø–æ –º–∞–ø–ø–∏–Ω–≥—É UID ${mappedUID}`);
                            } else {
                                console.log(`[TARA DEBUG] ‚ùå –¢–æ–≤–∞—Ä –ø–æ –º–∞–ø–ø–∏–Ω–≥—É UID ${mappedUID} –∏–º–µ–µ—Ç TARA=${product.TARA}`);
                            }
                        }
                    }
                    
                    // 3. –ï—Å–ª–∏ TARA –≤—Å–µ –µ—â–µ false, –∏—â–µ–º –Ω–∞–ø—Ä—è–º—É—é –ø–æ ID
                    if (!item.TARA && catalogByID[item.id]) {
                        const product = catalogByID[item.id];
                        console.log(`[TARA DEBUG] –ù–∞–π–¥–µ–Ω —Ç–æ–≤–∞—Ä –ø–æ ID ${item.id}:`, product);
                        
                        if (product.TARA === true) {
                            item.TARA = true;
                            console.log(`[TARA DEBUG] ‚úÖ –¢–æ–≤–∞—Ä ${item.name} –∏–º–µ–µ—Ç TARA=true –ø–æ ID ${item.id}`);
                        } else {
                            console.log(`[TARA DEBUG] ‚ùå –¢–æ–≤–∞—Ä –ø–æ ID ${item.id} –∏–º–µ–µ—Ç TARA=${product.TARA}`);
                        }
                    }
                    
                    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º TARA –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ —Å UID c46435b8-ce40-11ef-a721-50ebf6b0a0c4 (–ë–∞–ª–ª–æ–Ω)
                    if (item.uid === "c46435b8-ce40-11ef-a721-50ebf6b0a0c4" || 
                        (window.uidMap && window.uidMap[item.id] === "c46435b8-ce40-11ef-a721-50ebf6b0a0c4")) {
                        item.TARA = true;
                        console.log(`[TARA DEBUG] ‚ö†Ô∏è –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ TARA=true –¥–ª—è –ë–∞–ª–ª–æ–Ω–∞`);
                    }
                    
                    // –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    console.log(`[TARA DEBUG] –ò—Ç–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ TARA –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${item.name}: ${item.TARA ? 'true' : 'false'}`);
                });
            }
            
            // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–≤–∞—Ä—ã
            cart.forEach((item, index) => {
                if (index >= itemsToShow) return;
                
                // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ price —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º
                const price = parseFloat(item.price) || 0;
                console.log(`[TARA DEBUG] –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–æ–≤–∞—Ä–∞ ${item.name}, —Ü–µ–Ω–∞: ${price}, TARA: ${item.TARA ? 'true' : 'false'}`);
                
                const itemTotal = price * (parseInt(item.quantity) || 0);
                totalSum += itemTotal;
                
                const itemElement = document.createElement('div');
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–æ–≤–∞—Ä —Ç–∞—Ä–æ–π –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –∫–ª–∞—Å—Å
                itemElement.className = `cart-item${item.TARA ? ' tara-item' : ''}`;
                
                console.log(`[TARA DEBUG] –≠–ª–µ–º–µ–Ω—Ç—É –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${item.name} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–ª–∞—Å—Å: ${itemElement.className}`);
                
                // –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∫—É –¢–ê–†–ê, –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä —è–≤–ª—è–µ—Ç—Å—è —Ç–∞—Ä–æ–π
                const taraLabel = item.TARA ? '<span class="tara-badge">–¢–ê–†–ê</span>' : '';
                
                itemElement.innerHTML = `
                    <div class="cart-item-info">
                        <h3 class="cart-item-name">${item.name}${taraLabel}</h3>
                        <div class="cart-item-details">
                            <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${item.quantity}</p>
                            <p>–¶–µ–Ω–∞: ${price.toFixed(2)}‚ÇΩ</p>
                            <p>–°—É–º–º–∞: ${itemTotal.toFixed(2)}‚ÇΩ</p>
                        </div>
                    </div>
                    <div class="cart-item-controls">
                        <button onclick="removeItem(${index})" class="button button-delete">–£–¥–∞–ª–∏—Ç—å</button>
                        <div class="edit-volume-container">
                            <button onclick="toggleQuantityEditor(this, ${index})" class="button">–ò–∑–º–µ–Ω–∏—Ç—å –æ–±—ä–µ–º</button>
                            <div class="quantity-editor">
                                <div class="quantity-controls">
                                    <button onclick="decrementEditorQuantity(this)" class="button">‚àí</button>
                                    <input type="number" value="${item.quantity}" min="1" class="quantity-input editor-quantity">
                                    <button onclick="incrementEditorQuantity(this)" class="button">+</button>
                                </div>
                                <div style="display: flex; justify-content: center; gap: 8px;">
                                    <button onclick="saveQuantity(this, ${index})" class="button button-confirm">‚úì</button>
                                    <button onclick="cancelEditing(this)" class="button button-cancel">‚úï</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                cartItems.appendChild(itemElement);
            });
            
            console.log(`[TARA DEBUG] –û–±—â–∞—è —Å—É–º–º–∞ —Ä–∞—Å—á–∏—Ç–∞–Ω–∞: ${totalSum.toFixed(2)}‚ÇΩ`);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—É–º–º—É
            if (!document.getElementById('total_amount').textContent || 
                document.getElementById('total_amount').textContent === '0.00' ||
                document.getElementById('total_amount').textContent === '0') {
                document.getElementById('total_amount').textContent = totalSum.toFixed(2);
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
        checkAuthAndRedirect();
        displayCart();
    </script>
</body>
</html> 